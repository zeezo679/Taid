using Demo.Infrastructure;
using Demo.Models.Entities;
using Demo.Models.Repository;
using Demo.ViewModel;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.Rendering;

namespace Demo.Controllers;


public class CourseController : Controller
{

    private CourseRepository CourseRepository = new CourseRepository();
    private InstructorRepository InstructorRepository = new InstructorRepository();
    private AppDbContext _context = new AppDbContext();


      [HttpGet]
    //[Route("courses")] -> this route has higher priority than the routing in the program.cs
    public IActionResult Index()
    {
        List<Course> courses = CourseRepository.Load();
        List<string> Errors = new List<string>();
        List<Department> departments = _context.Departments.ToList();
        List<Instructor> instructors = InstructorRepository.Load() ?? new List<Instructor>();


        if (courses is null)
        {
            Errors.Add("Cannot fetch courses from the database");
            ViewBag.Errors = Errors;
            return RedirectToAction("Index", "Home");
        }

        ViewBag.Departments = departments ?? new List<Department>();
        ViewBag.Instructors = instructors;
        return View("Index", courses);
    }


    [HttpGet("course/add")]
    public IActionResult AddCourse()
    {

        CourseViewModel courseView = new CourseViewModel();

        var instructors = _context.Instructors.Select(i => new SelectListItem
        {
            Value = i.Id.ToString(),
            Text = i.Name
        }).ToList();

        courseView.Instructors = instructors;
        courseView.Departments = _context.Departments.ToList();

        return View("AddCourse", courseView);
    }


    [HttpPost]
    [ValidateAntiForgeryToken]
    public IActionResult AddCourse(int id,CourseViewModel CourseView)
    {
        CourseView.Departments = _context.Departments.ToList();
        CourseView.Instructors = _context.Instructors.Select(i => new SelectListItem
        {
            Value = i.Id.ToString(),
            Text = i.Name
        }).ToList();

        if (ModelState.IsValid) //server side validation
        {
            try
            {
                Course newCourse = new Course();
                var course = new Course
                {
                    Name = CourseView.Name,
                    Degree = CourseView.Degree,
                    MinDegree = CourseView.MinDegree,
                    DeptId = CourseView.DeptId,
                    Instructors = _context.Instructors.Where(i => CourseView.InstructorIds.Contains(i.Id)).ToList()
                };

                int oldCourseCount = _context.Courses.Count();
                _context.Courses.Add(course);
                _context.SaveChanges();
                int newCourseCount = _context.Courses.Count();

                if (newCourseCount > oldCourseCount)
                {
                    TempData["Message"] = "Course Added Successfully";
                }
                else TempData["Message"] = string.Empty;
                
                return RedirectToAction("Index");
            }
            catch (Exception ex)
            {
                ModelState.AddModelError(string.Empty, ex.Message);
            }
        }
        return View(CourseView);
    }
    [HttpGet]
    public IActionResult Edit(int id)
    {
        CourseViewModel courseView = new CourseViewModel();
        var course = CourseRepository.Get(id);


        var instructors = _context.Instructors.Select(i => new SelectListItem
        {
            Value = i.Id.ToString(),
            Text = i.Name
        }).ToList();

        courseView.Instructors = instructors;
        courseView.Departments = _context.Departments.ToList();
        courseView.Name = course.Name;
        courseView.DeptId = course.DeptId;
        courseView.Id = course.Id;
        courseView.Degree = course.Degree;
        courseView.MinDegree = course.MinDegree;

        return View("Edit", courseView);
    }

    [HttpPost]
    [ValidateAntiForgeryToken]
    public IActionResult Edit(int id, CourseViewModel newCourse)
    {
        var oldCourse = CourseRepository.Get(id);

        newCourse.Departments = _context.Departments.ToList();
        newCourse.Instructors = _context.Instructors.Select(i => new SelectListItem
        {
            Value = i.Id.ToString(),
            Text = i.Name
        }).ToList();

        oldCourse.Name = newCourse.Name;
        oldCourse.DeptId = newCourse.DeptId;
        oldCourse.Degree = newCourse.Degree;
        oldCourse.MinDegree = newCourse.MinDegree;
        oldCourse.Instructors = _context.Instructors.Where(i => newCourse.InstructorIds.Contains(i.Id)).ToList();

        _context.SaveChanges();
        return RedirectToAction("Index");
    }

    public JsonResult IsValidMinDegree(decimal minDegree, decimal degree)
    {
        if(minDegree < degree)
            return Json(true);
        else
            return Json("Minimum Degree must be less than the degree you entered");
    }

    [HttpGet]
    public IActionResult CourseDetails(int id)
    {
        var course = CourseRepository.Get(id);
        var instructors = InstructorRepository.Load();
        
        course.Instructors = instructors;

        return PartialView("CourseDetailsPartial", course);
    }
}
